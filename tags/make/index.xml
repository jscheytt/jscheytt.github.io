<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Make on Josia's Blog</title><link>https://jscheytt.github.io/tags/make/</link><description>Recent content in Make on Josia's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Josia Scheytt</copyright><lastBuildDate>Mon, 06 Sep 2021 13:38:15 +0200</lastBuildDate><atom:link href="https://jscheytt.github.io/tags/make/index.xml" rel="self" type="application/rss+xml"/><item><title>The Story of My First Makefile â€” Half-Versioned Secrets Management</title><link>https://jscheytt.github.io/p/the-story-of-my-first-makefile-half-versioned-secrets-management/</link><pubDate>Mon, 06 Sep 2021 13:38:15 +0200</pubDate><guid>https://jscheytt.github.io/p/the-story-of-my-first-makefile-half-versioned-secrets-management/</guid><description>&lt;p&gt;As a DevOps Engineer one key skill is &lt;strong&gt;automating repetitive tasks&lt;/strong&gt;.
What most people grab for intuitively is writing Shell scripts (be it Bash, zsh, fish or whichever flavor you prefer).
And there are a lot many good reasons to do so:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It is closest to typing commands directly in the terminal.&lt;/li&gt;
&lt;li&gt;You don&amp;rsquo;t have to learn a dedicated programming language.&lt;/li&gt;
&lt;li&gt;It is very portable to other platforms like e.g. a CI server.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;But once you start managing an increasing number of tasks with your scripts, you start to face another problem:
How do you &lt;em&gt;manage your scripts&lt;/em&gt;?&lt;/p&gt;
&lt;p&gt;Personally, I have always loved being able to enter some new place where &lt;strong&gt;conventions&lt;/strong&gt; were already in place.
It takes away so much work and mental effort at the beginning, and you can just get to work quickly.
(That might explain why I fell in love with â¤ï¸ &lt;a class="link" href="https://rubyonrails.org/doctrine/#convention-over-configuration" target="_blank" rel="noopener"
&gt;Ruby on Rails&lt;/a&gt; before I dug into ğŸ’ Ruby.)&lt;/p&gt;
&lt;p&gt;Shell scripts by their very nature do not pose any restrictions regarding e.g. naming patterns or directory structures.
Honestly, I think there never will be, and that is ok.
But what I have come to appreciate a lot recently is &lt;strong&gt;&lt;a class="link" href="https://www.gnu.org/software/make/" target="_blank" rel="noopener"
&gt;Make&lt;/a&gt;&lt;/strong&gt; as a &lt;strong&gt;companion&lt;/strong&gt; for my Shell scripts.&lt;/p&gt;
&lt;h2 id="-make-vs--shell-in-a--nutshell"&gt;ğŸ— Make vs. ğŸš Shell in a ğŸ¥œ Nutshell
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Purpose: Make is good at &lt;strong&gt;creating files&lt;/strong&gt;, Shell is good at &lt;strong&gt;executing scripts&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Portability: If your system has Bash, chances are pretty high that Make is also available.&lt;/li&gt;
&lt;li&gt;Developer API: Make has a &lt;strong&gt;clear entrypoint&lt;/strong&gt; (namely &lt;code&gt;make&lt;/code&gt;), Shell can be everything you want it to be.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Make is a tool that has its origin in the world of compiled languages, especially C.
Compiling source code into binary artifacts (and doing so ğŸ &lt;em&gt;economically&lt;/em&gt;) is what Make was originally designed for.
I mean, the name of a tool should make its use clear, but let me just state this again for my future self:
Make is meant to ğŸ— make (create) files.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;It&amp;rsquo;s all about target files.&lt;/strong&gt;
That&amp;rsquo;s why it makes sense to approach a Makefile with a mindset of &amp;ldquo;What do I want to create/build?&amp;rdquo; instead of &amp;ldquo;What do I want to perform?&amp;rdquo;
To me this sounds very reminiscent of the distinction between &lt;em&gt;declarative and imperative&lt;/em&gt; programming.&lt;/p&gt;
&lt;h2 id="safely-versioned-secrets-management"&gt;Safely Versioned Secrets Management
&lt;/h2&gt;&lt;p&gt;My concrete entrypoint into Make was the following use case I had lately, and it hopefully helps to illustrate the point of target files:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â˜¸ï¸ You have 2 AWS accounts with 1 &lt;strong&gt;Kubernetes&lt;/strong&gt; cluster each.
(One is for running a dev and a staging environment, the other one is running the production environment.)&lt;/li&gt;
&lt;li&gt;ğŸ”‘ Secrets are stored in AWS &lt;strong&gt;Secrets Manager&lt;/strong&gt; and synced into the cluster via &lt;a class="link" href="https://github.com/external-secrets/kubernetes-external-secrets" target="_blank" rel="noopener"
&gt;ExternalSecrets&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;â›”ï¸ You are &lt;strong&gt;not allowed&lt;/strong&gt; to store secrets in Git, not even in encrypted form.&lt;/li&gt;
&lt;li&gt;ğŸª£ The secrets are JSON files and the &lt;strong&gt;key names&lt;/strong&gt; are important, so you want to store them in Git.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;What I did as a first step was to create sample secrets files that contained the keys but no valid data (kind of the &lt;em&gt;schema&lt;/em&gt; of the secrets):&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;secrets
â”œâ”€â”€ dev # One directory per target environment
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ staging
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ prod
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ config1.sample.json # One sample file per secret
â”œâ”€â”€ service2.sample.json
â””â”€â”€ service3.sample.json
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I put the keys I needed into the sample files and as a value a description of what to put in (or e.g. from which Password Service to fetch the value from).
The file &lt;code&gt;service2.sample.json&lt;/code&gt; would e.g. look like this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-json" data-lang="json"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nt"&gt;&amp;#34;EXTERNAL_API_KEY&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;API Key of EXTERNAL_SERVICE&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nt"&gt;&amp;#34;CLOUD_SERVICE_CLIENT_SECRET&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;client secret for accessing CLOUD_SERVICE&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nt"&gt;&amp;#34;CLOUD_SERVICE_PASSWORD&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;password for accessing CLOUD_SERVICE&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nt"&gt;&amp;#34;BASIC_AUTH_PASSWORD&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;password for sending via Basic Auth&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The target structure I wanted to achieve was this:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;secrets
â”œâ”€â”€ dev
â”‚Â Â  â”œâ”€â”€ config1.json # This file contains the *keys* of
â”‚ â”‚ # secrets/config1.sample.json
â”‚ â”‚ # and the actual secret *values*!
â”‚Â Â  â”œâ”€â”€ service2.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ staging
â”‚Â Â  â”œâ”€â”€ config1.json # Contains key of sample file and
â”‚ â”‚ # values for staging environment.
â”‚Â Â  â”œâ”€â”€ service2.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ prod
â”‚Â Â  â”œâ”€â”€ config1.json
â”‚Â Â  â”œâ”€â”€ service2.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ config1.sample.json
â”œâ”€â”€ service2.sample.json
â””â”€â”€ service3.sample.json
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In order to not commit any actual secrets into version control, I added the following entries to my &lt;strong&gt;.gitignore&lt;/strong&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# Ignore secret data ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;secrets/**/*.json
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# ... but keep the samples&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;!secrets/*.sample.json
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="copying-the-samples"&gt;Copying the Samples
&lt;/h3&gt;&lt;p&gt;Now how do you copy the files to all environment&amp;rsquo;s directories?
And how do you make sure you copy them &lt;em&gt;exactly once&lt;/em&gt; (so you don&amp;rsquo;t lose the secrets you already entered)?&lt;/p&gt;
&lt;p&gt;You could create a script with the following logic:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# For each environment directory:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;## For each sample file:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;### Extract the service name&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;### Check if target secret file already exists&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;### If not, copy sample to target file&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;But now, ğŸ— Make to the rescue:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;### Variables
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Fetch all sample files.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;secrets_samples&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;wildcard secrets/*.sample.json&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Construct the paths for all dev secrets destinations.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;dev_secrets&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;patsubst secrets/%.sample.json,secrets/dev/%.json,&lt;span class="k"&gt;$(&lt;/span&gt;secrets_samples&lt;span class="k"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Construct the paths for all staging secrets destinations.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;staging_secrets&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;patsubst secrets/dev/%,secrets/staging/%,&lt;span class="k"&gt;$(&lt;/span&gt;dev_secrets&lt;span class="k"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Construct the paths for all staging secrets destinations.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;prod_secrets&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;patsubst secrets/dev/%,secrets/prod/%,&lt;span class="k"&gt;$(&lt;/span&gt;dev_secrets&lt;span class="k"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Gather the paths of all secrets&amp;#39; destinations.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;all_secrets&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;dev_secrets&lt;span class="k"&gt;)&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;staging_secrets&lt;span class="k"&gt;)&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;prod_secrets&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;### Rules
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¯ Purpose: &amp;#34;Copy all samples to their destinations.&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¤“ What Make sees: &amp;#34;When you build the file secrets.copy-templates,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# make sure that all files in $(all_secrets) have been built first.&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ‘©â€ğŸ« Explanation: A rule can be empty, and a rule can have prerequisites
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# on the first line. I like to think of such a rule as a kind of shortcut.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets.copy-templates&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;&lt;span class="nv"&gt;all_secrets&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¯ Purpose: &amp;#34;Ensure that Make still runs the job &amp;#39;secrets.copy-templates&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# even if a file called &amp;#39;secrets.copy-templates&amp;#39; is created.&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¤“ What Make sees: &amp;#34;I am supposed to always build secrets.copy-templates
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# even if that file already exists.&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;.PHONY&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;.&lt;span class="n"&gt;copy&lt;/span&gt;-&lt;span class="n"&gt;templates&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¯ Purpose: &amp;#34;Copy the file on the right to the file on the left.&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ¤“ What Make sees: &amp;#34;When a file matching the pattern secrets/dev/(.*).json
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# is built, execute this rule.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Also first make sure that the corresponding file secrets/$1.sample.json
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# has been built before.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# And the rule is: Copy the source file on the right ($&amp;lt;) to the destination
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# file on the left ($@).&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# ğŸ‘©â€ğŸ« Explanation: These 3 rules are applied when you call secrets.copy-templates
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# because it requires $(all_secrets) to be built.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/dev/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; cp $&amp;lt; &lt;span class="nv"&gt;$@&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/staging/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; cp $&amp;lt; &lt;span class="nv"&gt;$@&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/prod/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; cp $&amp;lt; &lt;span class="nv"&gt;$@&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If you now execute &lt;code&gt;make secrets.copy-templates&lt;/code&gt;, the sample files will be copied to all environment directories.
And if you run that same command again, ğŸ™Š &lt;strong&gt;Make will not copy anything&lt;/strong&gt; because it intelligenty detected that the source files have not changed since the last execution.&lt;/p&gt;
&lt;p&gt;The code above is certainly not optimal - I bet you could abstract away the environment names with bit of metaprogramming, but let&amp;rsquo;s not optimize prematurely.
I think the result is already impressive, especially if you consider the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â˜ï¸ You don&amp;rsquo;t even have to call the job explicitly to run it.
As long as &lt;code&gt;secrets.copy-templates&lt;/code&gt; is the first build defined in the Makefile, you can even execute just &lt;code&gt;make&lt;/code&gt; &lt;em&gt;without any parameters&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;ğŸ‘¨â€ğŸ’» Onboarding a new colleague to your repository now sounds a lot more like:
&amp;ldquo;Yes, do read the README, but above all execute &lt;code&gt;make&lt;/code&gt;.&amp;rdquo;
&lt;ul&gt;
&lt;li&gt;â›‘ This is especially true if your Makefile contains &lt;strong&gt;&lt;a class="link" href="https://marmelab.com/blog/2016/02/29/auto-documented-makefile.html" target="_blank" rel="noopener"
&gt;good help texts&lt;/a&gt;&lt;/strong&gt; for every rule.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="how-not-to-shoot-yourself-in-the-foot"&gt;How Not To Shoot Yourself in the Foot
&lt;/h4&gt;&lt;p&gt;Make was made primarily for building binaries from source code.
The fact that we are able to use it in the way described above comes with a warning:
If you do the following, you will lose the secret data you already entered into the secret files:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Execute &lt;code&gt;make secrets.copy-templates&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Edit a &lt;strong&gt;sample file&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Execute &lt;code&gt;make secrets.copy-templates&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;ğŸ’¥ Make will &lt;strong&gt;copy and overwrite&lt;/strong&gt; the edited sample file to all environment secret files.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Why?
Make compares timestamps, and when the source has a newer last-modified timestamp than the destination it will execute the rule&lt;/p&gt;
&lt;p&gt;Can we circumvent this?
We sure can.
You can either make sure that you edit each environment file after editing the sample file.
Or you change the last-modified timestamp &lt;strong&gt;via a build&lt;/strong&gt; in the Makefile ğŸ˜‰:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets.ensure-copy-once&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; f in &lt;span class="k"&gt;$(&lt;/span&gt;all_secrets&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -f &lt;span class="nv"&gt;$$&lt;/span&gt;f &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; touch &lt;span class="nv"&gt;$$&lt;/span&gt;f&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;done&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now whenever you edit a sample file &lt;em&gt;after the initial secrets.copy-templates&lt;/em&gt; you run this build via &lt;code&gt;make secrets.ensure-copy-once&lt;/code&gt; and ğŸ›¡ your secrets will not be deleted.&lt;/p&gt;
&lt;h3 id="extension-environment-specific-sample-files"&gt;Extension: Environment-specific Sample Files
&lt;/h3&gt;&lt;p&gt;One implicit assumption in my structure was that the secrets in service2 will always have the same schema &lt;strong&gt;in every environment&lt;/strong&gt;.
One day it so happened that service2 needed to have additional keys on prod, but they &lt;strong&gt;should not be present&lt;/strong&gt; on dev or staging.&lt;/p&gt;
&lt;p&gt;I adjusted my desired structure like this:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;secrets
â”œâ”€â”€ dev
â”‚Â Â  â”œâ”€â”€ config1.json
â”‚Â Â  â”œâ”€â”€ service2.json # Contains keys from service2.sample.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ staging
â”‚Â Â  â”œâ”€â”€ config1.json
â”‚Â Â  â”œâ”€â”€ service2.json # Contains keys from service2.sample.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ prod
â”‚Â Â  â”œâ”€â”€ config1.json
â”‚Â Â  â”œâ”€â”€ service2.json # Contains keys from service2.sample.prod.json
â”‚Â Â  â”œâ”€â”€ service3.json
â”‚Â Â  â””â”€â”€ .keep
â”œâ”€â”€ config1.sample.json
â”œâ”€â”€ service2.sample.json # Default sample file
â”œâ”€â”€ service2.sample.prod.json # Prod-specific sample file
â””â”€â”€ service3.sample.json
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;And I wrote my first &lt;strong&gt;Makefile function&lt;/strong&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# A Make function can take in an arbitrary number of numbered parameters.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;define&lt;/span&gt; &lt;span class="err"&gt;copy_template&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="err"&gt;cp&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;1&lt;span class="k"&gt;)&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;2&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="c"&gt;# Check if there is a more environment-specific sample file
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;&lt;span class="nb"&gt;eval&lt;/span&gt; ENVIRONMENT :&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;shell &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;2&lt;span class="k"&gt;)&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sed -E &lt;span class="s1"&gt;&amp;#39;s#secrets/(.*)/.*#\1#&amp;#39;&lt;/span&gt;&lt;span class="k"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;&lt;span class="nb"&gt;eval&lt;/span&gt; ENVIRONMENT_SAMPLE_FILE :&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;patsubst %.sample.json,%.sample.&lt;span class="k"&gt;$(&lt;/span&gt;ENVIRONMENT&lt;span class="k"&gt;)&lt;/span&gt;.json,&lt;span class="k"&gt;$(&lt;/span&gt;1&lt;span class="k"&gt;)))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; @# If environment-specific file exists, copy it to destination
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -f &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;ENVIRONMENT_SAMPLE_FILE&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;then&lt;/span&gt; cp &lt;span class="k"&gt;$(&lt;/span&gt;ENVIRONMENT_SAMPLE_FILE&lt;span class="k"&gt;)&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;2&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;endef&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Calling a Make function works by executing &amp;#39;call&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# with the function name and all its parameters as a list.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# My previous rules now became this:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/dev/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;call copy_template,$&amp;lt;,&lt;span class="nv"&gt;$@&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/staging/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;call copy_template,$&amp;lt;,&lt;span class="nv"&gt;$@&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets/prod/%.json&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;secrets&lt;/span&gt;/%.&lt;span class="n"&gt;sample&lt;/span&gt;.&lt;span class="n"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;call copy_template,$&amp;lt;,&lt;span class="nv"&gt;$@&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="-perfect-symphony-calling-scripts-from-make"&gt;ğŸ£ Perfect Symphony: Calling Scripts From Make
&lt;/h3&gt;&lt;p&gt;It&amp;rsquo;s all good and nice to have your secrets created, but how do you deploy them to AWS Secrets Manager?
Of course you write a thin wrapper around the wonderfully verbose AWS CLI:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#!/usr/bin/env bash
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;set&lt;/span&gt; -euo pipefail
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# set -x # DEBUG&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;secret_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# Use second argument or read stdin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;secret_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;2&lt;/span&gt;&lt;span class="k"&gt;:-$(&lt;/span&gt;cat -&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="nv"&gt;$secret_value&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt; &lt;span class="c1"&gt;# DEBUG&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# Create secret in idempotent way, avoid script from failing&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;set&lt;/span&gt; +e
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;aws secretsmanager create-secret --name &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="nv"&gt;$secret_name&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;&amp;gt; /dev/null
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;set&lt;/span&gt; -e
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# Put secret value and output response to stdout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;aws secretsmanager put-secret-value --secret-id &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="nv"&gt;$secret_name&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt; &lt;span class="se"&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; --secret-string &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="nv"&gt;$secret_value&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; cat
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In your terminal you would call it e.g. like this:&lt;br&gt;
&lt;code&gt;./helpers/deploy-secret.sh envs/dev/config1-secrets &amp;lt; secrets/dev/config1.json&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s make a generic rule in Make to execute this script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# The dependency on $(all_secrets) is to make sure that the secrets files exist
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# before deploying them.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secret.deploy&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="k"&gt;$(&lt;/span&gt;&lt;span class="nv"&gt;all_secrets&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ./helpers/deploy-secret.sh &lt;span class="k"&gt;$(&lt;/span&gt;name&lt;span class="k"&gt;)&lt;/span&gt; &amp;lt; secrets/&lt;span class="k"&gt;$(&lt;/span&gt;environment&lt;span class="k"&gt;)&lt;/span&gt;/&lt;span class="k"&gt;$(&lt;/span&gt;filename&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The call to the script that you executed above would become this:&lt;br&gt;
&lt;code&gt;make secret.deploy name=envs/dev/config1-secrets environment=dev filename=config1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;As we have multiple services, let&amp;rsquo;s add one rule per service:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# The secret values in this one are the same across all environments
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secret.deploy.config1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy &lt;span class="nv"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;envs/config1-secrets &lt;span class="nv"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;config1.json
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# service2 has different secret values on the different environments
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secret.deploy.service2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy &lt;span class="nv"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;envs/&lt;span class="k"&gt;$(&lt;/span&gt;environment&lt;span class="k"&gt;)&lt;/span&gt;/service2-secrets &lt;span class="nv"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;service2.json
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# service 3 also has environment-specific secret values
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secret.deploy.service3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy &lt;span class="nv"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;envs/&lt;span class="k"&gt;$(&lt;/span&gt;environment&lt;span class="k"&gt;)&lt;/span&gt;/service3-secrets &lt;span class="nv"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;service3.json
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now we can tie these together into one rule for a whole environment:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-make" data-lang="make"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Deploy all secrets for one environment
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets.deploy.all&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy.config1
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy.service2
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secret.deploy.service3
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Deploy all secrets for the dev cluster
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets.deploy.dev&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secrets.deploy.all &lt;span class="nv"&gt;environment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dev
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secrets.deploy.all &lt;span class="nv"&gt;environment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;staging
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c"&gt;# Deploy all secrets for the prod cluster
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nf"&gt;secrets.deploy.prod&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;$(&lt;/span&gt;MAKE&lt;span class="k"&gt;)&lt;/span&gt; secrets.deploy.all &lt;span class="nv"&gt;environment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;prod
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;âœ… Once you are authenticated to the corresponding AWS account, you can deploy your secrets with either &lt;code&gt;make secrets.deploy.dev&lt;/code&gt; or &lt;code&gt;make secrets.deploy.prod&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id="summarizing"&gt;Summarizing
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Make gives you a consistent and clean Developer API.&lt;/li&gt;
&lt;li&gt;Make is almost universally installed everywhere.&lt;/li&gt;
&lt;li&gt;Don&amp;rsquo;t decide between either Make &lt;strong&gt;or&lt;/strong&gt; Shell - use both together.
Refactor more complex logic into separate Shell scripts (like isolated functions) which are called from within Make.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can check out the entire Makefile (including the secrets structure and scripts) in this &lt;a class="link" href="https://github.com/jscheytt/jscheytt.github.io.hugo/tree/main/content/post/story-first-makefile" target="_blank" rel="noopener"
&gt;Git repo&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="credits"&gt;Credits
&lt;/h2&gt;&lt;p&gt;I am indebted to the following parties in making my start into the world of Make a lot smoother than I expected:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Isaac Z. Schlueter for his &lt;a class="link" href="https://gist.github.com/isaacs/62a2d1825d04437c6f08" target="_blank" rel="noopener"
&gt;interactive Gist&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The guys at &lt;a class="link" href="https://www.upbound.io/" target="_blank" rel="noopener"
&gt;Upbound&lt;/a&gt; for creating &lt;a class="link" href="https://crossplane.io/" target="_blank" rel="noopener"
&gt;Crossplane&lt;/a&gt; where they use Make in &lt;a class="link" href="https://github.com/crossplane/provider-aws" target="_blank" rel="noopener"
&gt;their providers&lt;/a&gt; and even distribute &lt;a class="link" href="https://github.com/upbound/build" target="_blank" rel="noopener"
&gt;common functionality&lt;/a&gt; as a Git submodule&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>